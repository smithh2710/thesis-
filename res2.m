clear; clc; close all;

comp_ref = [1.227, 0.824, 47.221, 7.560, 4.414, 0.844, 2.141, 0.925, 1.126, 1.588, 2.765, 2.528, 2.310, 5.806, 4.434, 3.386, 2.586, 2.523, 1.761, 1.697, 1.317, 1.015]';
comp_ref = comp_ref / sum(comp_ref);

M_gmol = [28.014, 44.010, 16.043, 30.070, 44.097, 58.124, 58.124, 72.151, 72.151, 86.178, 96.000, 107.000, 121.000, 146.526, 189.406, 235.798, 275.597, 323.260, 379.146, 447.348, 547.702, 754.228]';

Tc = [126.200, 304.200, 190.600, 305.400, 369.800, 408.100, 425.200, 460.400, 469.600, 507.400, 537.031, 557.574, 581.291, 620.907, 677.320, 730.657, 772.695, 820.224, 872.393, 933.128, 1017.950, 1190.769]' ;


Pc = [394.39, 7376.46, 4600.15, 4883.87, 4245.52, 3647.70, 3799.69, 3384.26, 3374.12, 2968.82, 2960.14, 2729.81, 2488.77, 2174.44, 1848.95, 1642.73, 1530.54, 1436.19, 1359.69, 1295.57, 1234.02, 1165.75]' * 1e3;

acentric = [0.0400, 0.2250, 0.0080, 0.0980, 0.1520, 0.1760, 0.1930, 0.2270, 0.2510, 0.2960, 0.3375, 0.3742, 0.4204, 0.5020, 0.6263, 0.7484, 0.8421, 0.9406, 1.0341, 1.1144, 1.1606, 0.9203]';

c_JY = [-4.23; -1.91; -5.20; -5.79; -6.35; -7.18; -6.49; -6.20; -5.12; 1.42;7.45; 9.20; 10.32; 19.00; 24 ; 23 ; 20 ; 13 ; 92.3 ;-17;-49;-117];

R = 8.3144598;
Zc_est = 0.2905 - 0.085 * acentric;
Vc = Zc_est .* R .* Tc ./ Pc * 1e6;
Vc_lit = [89.8; 94.0; 99.0; 148.0; 203.0; 263.0; 255.0; 306.0; 304.0; 370.0];
Vc(1:10) = Vc_lit;

n = length(comp_ref);
BIP = zeros(n, n);

BIP(1,2) = -0.017; BIP(2,1) = -0.017;  % N2-CO2
BIP(1,3) = 0.0311 ; BIP(3,1)= 0.0311;
BIP(1,4) = 0.0515 ; BIP(4,1) = 0.0515 ; 
BIP(1,5) = 0.0852 ; BIP(5,1)= 0.0852 ; 
BIP(1,6) = 0.1033 ; BIP(6,1)=0.1033; 
BIP(1,7) = 0.0800 ; BIP(7,1) = 0.0800;
BIP(1,8)= 0.0922 ; BIP(8,1) = 0.0922 ; 
BIP(1,9)= 0.1000 ; BIP(9,1)=0.1000;
BIP(1,10:n)= 0.0800 ; BIP(10:n,1)= 0.0800 ;


BIP(2,3:10) = 0.120; BIP(3:10,2) = 0.120;  
BIP(2,11:n) = 0.10; BIP(11:n,2) = 0.10;
h_ref = 6.5;
press_ref = 243e5;
temp_ref = 90 + 273.15;
tol = 10^(-30);
maxiter = 1000 ; 

vt_params.Vc = Vc;
vt_params.c_custom = c_JY;


depth_range_goc = [0, 12];

% [GOC_depth, GOC_pressure, GOC_comp, info] = detect_GOC(comp_ref, press_ref, temp, h_ref, depth_range_goc, Pc, Tc, acentric, BIP, M_gmol, 6, vt_params);

% pressb_ini = 243e5 ; 
% [pressb, ~] = pressbub_multicomp_newton(comp_ref, pressb_ini , temp_ref ,Pc, Tc, acentric, BIP, tol, maxiter)

[comp_h, press_h, pressbub_h, pressdew_h] = main(57.5, 6.5, comp_ref, press_ref, temp_ref, Pc, Tc, acentric, BIP, M_gmol, 6, vt_params)
components = ["N2","CO2","C1","C2","C3","iC4","nC4","iC5","nC5","C6","C7","C8","C9","C10-C14","C15-C19","C20-C23","C24-C28","C29-C33","C34-C39","C40-C47","C48-C58","C59-C80"];  
comp_ref = [0.810, 0.095, 36.183, 10.631, 12.387, 2.639, 4.763, 2.050, 2.082, 2.650, 1.482, 1.398, 1.318, 5.548, 4.140, 2.541, 2.443, 1.823, 1.588, 1.410, 1.121, 0.897]';
comp_ref = comp_ref ./ sum(comp_ref);

M_gmol = [28.014, 44.010, 16.043, 30.070, 44.097, 58.124, 58.124, 72.151, 72.151, 86.178, 96.000, 107.000, 121.000, 159.764, 234.124, 296.203, 357.727, 428.362, 504.613, 600.710, 729.856, 936.872]';
Tc = [-146.950, 31.050, -82.550, 32.250, 96.650, 134.950, 152.050, 187.250, 196.450, 234.250, 267.518, 287.931, 311.532, 370.745, 459.444, 523.306, 582.312, 645.426, 710.441, 788.995, 890.304, 1048.305]' + 273.15;

Pc = [33.94, 73.76, 46.00, 48.84, 42.46, 36.48, 38.00, 33.84, 33.74, 29.69, 30.59, 28.17, 25.65, 21.11, 16.88, 15.17, 14.13, 13.34, 12.77, 12.29, 11.86, 11.46]' * 10^(5);

acentric = [0.0400, 0.2250, 0.0080, 0.0980, 0.1520, 0.1760, 0.1930, 0.2270, 0.2510, 0.2960, 0.3379, 0.3746, 0.4208, 0.5458, 0.7466, 0.8875, 1.0015, 1.0963, 1.1530, 1.1536, 1.0309, 0.5479]';

c = [-4.23, -1.64, -5.20, -5.79, -6.35, -7.18, -6.49, -6.20, -5.12, 1.39, 11.65, 14.54, 17.98, 26.18, 30.07, 24.53, 13.75, -3.56, -25.88, -57.58, -103.90, -178.49]' * 1e-6;


R = 8.314; 
n = length(comp_ref);


BIP = zeros(n,n);
BIP(1,2) = -0.017; BIP(2,1) = -0.017;
BIP(1,3) = 0.0311 ; BIP(3,1)= 0.0311;
BIP(1,4) = 0.0515 ; BIP(4,1) = 0.0515 ; 
BIP(1,5) = 0.0852 ; BIP(5,1)= 0.0852 ; 
BIP(1,6) = 0.1033 ; BIP(6,1)=0.1033; 
BIP(1,7) = 0.0800 ; BIP(7,1) = 0.0800;
BIP(1,8)= 0.0922 ; BIP(8,1) = 0.0922 ; 
BIP(1,9)= 0.1000 ; BIP(9,1)=0.1000;
BIP(1,10:n)= 0.0800 ; BIP(10:n,1)= 0.0800 ;


BIP(2,3:10) = 0.120; BIP(3:10,2) = 0.120;
BIP(2,11:n) = 0.10; BIP(11:n,2) = 0.10;

M = M_gmol / 1000;




% Cp = C1 + C2*T + C3*T^2 + C4*T^3 (J/mol/K)
Cp_coeffs = [
    % Component      C1         C2          C3          C4
    31.15,      -0.014,     2.68e-5,    -1.17e-8;   % N2
    19.79,       0.073,    -5.60e-5,     1.72e-8;   % CO2
    19.25,       0.052,     1.20e-5,    -1.13e-8;   % C1
     5.41,       0.178,    -6.94e-5,     8.71e-9;   % C2
    -4.22,       0.306,    -1.59e-4,     3.21e-8;   % C3
    -1.39,       0.385,    -1.85e-4,     2.90e-8;   % iC4
     9.49,       0.331,    -1.11e-4,    -2.82e-9;   % nC4
    -9.52,       0.507,    -2.73e-4,     5.72e-8;   % iC5
    -3.63,       0.487,    -2.58e-4,     5.30e-8;   % nC5
    -4.41,       0.582,    -3.12e-4,     6.49e-8;   % C6
   -26.75,       0.581,    -1.99e-4,     0.000;     % C7
   -16.83,       0.611,    -2.32e-4,     0.000;     % C8
   -12.69,       0.678,    -2.66e-4,     0.000;     % C9
    -5.13,       0.891,    -3.64e-4,     0.000;     % C10-C14
     1.15,       1.302,    -5.33e-4,     0.000;     % C15-C19
     4.54,       1.648,    -6.73e-4,     0.000;     % C20-C23
     8.10,       2.002,    -8.13e-4,     0.000;     % C24-C28
    11.87,       2.404,    -9.72e-4,     0.000;     % C29-C33
    15.57,       2.839,    -1.14e-3,     0.000;     % C34-C39
    20.49,       3.392,    -1.36e-3,     0.000;     % C40-C47
    27.77,       4.139,    -1.66e-3,     0.000;     % C48-C58
    40.41,       5.363,    -2.14e-3,     0.000;     % C59-C80
];

H_ig_ref_per_mass = [
    -20;   % N2
     20;   % CO2  
      0;   % C1
    7.5;   % C2
     15;   % C3
     17;   % iC4
     17;   % nC4
     25;   % iC5
     25;   % nC5
     33;   % C6
      2;   % C7 (MW=96 < 150)
      2;   % C8 (MW=107 < 150)
      2;   % C9 (MW=121 < 150)
    877;   % C10-C14 (MW=159.752, 150-250)
    877;   % C15-C19 (MW=234.113, 150-250)
    880;   % C20-C23 (MW=296.195, 250-400)
    880;   % C24-C28 (MW=357.716, 250-400)
    639;   % C29-C33 (MW=428.351 > 400)
    639;   % C34-C39 (MW=504.597 > 400)
    639;   % C40-C47 (MW=600.681 > 400)
    639;   % C48-C58 (MW=729.800 > 400)
    639;   % C59-C80 (MW=936.663 > 400)
];


Vc =  [ 89.80, 94 , 99, 148, 203, 263, 255, 306, 304, 370, 401.33, 435.90 , 486.85, 650.18 , 972.20 , 1256.07 , 1554.87 , 1905.32 , 2295.45 , 2799.64 , 3493.09 , 4652.64]'  ;

temp_ref = 79.8 + 273.15;  
press_ref = 194*10^(5);       
h_ref = 8 ;               
temp_gradient = -0.025;    
tol = 10^(-30);
maxiter = 1000 ; 

vt_params.Vc = Vc;
vt_params.components = components;
vt_params.c_custom = c;

h = [0, 8, 21,28]; 
% pressb_ini = pressbubest_multicomp(comp_ref, temp_ref, Pc, Tc, acentric);
% [pressb, ~] = pressbub_multicomp_newton(comp_ref, pressb_ini , temp_ref ,Pc, Tc, acentric, BIP, tol, maxiter)

[comp_h, press_h, pressbub_h, pressdew_h] = main(0, 8, comp_ref, press_ref, temp_ref, Pc, Tc, acentric, BIP, M_gmol, 6, vt_params)



